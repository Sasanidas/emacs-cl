;;;; -*- emacs-lisp -*-
;;;
;;; Copyright (C) 2003 Lars Brinkhoff.
;;; This file implements operators in chapter 14, Conses.

(defun TERPRI ()
  (princ "\n"))

(defmacro* PRINT-UNREADABLE-OBJECT ((object stream &key identity) &body body)
  `(progn
    (princ "#<")
    (princ (TYPE-OF ,object))
    (princ " ")
    ,@body
    ,@(when identity
        `((princ " ")
	  (princ "identity")))
    (princ ">")))

(defun write-char-to-*current-stream* (char)
  (WRITE-CHAR char *current-stream*))

;;; Ad-hoc unexensible.
(defun PRINT (object &optional stream-designator)
  (let* ((stream (resolve-output-stream-designator stream-designator))
	 (*current-stream* stream)
	 (standard-output #'write-char-to-*current-stream*))
    (cond
      ((or (integerp object)
	   (floatp object)
	   (stringp object))
       (princ object))
      ((symbolp object)
       (cond
	 ((eq (SYMBOL-PACKAGE object) *PACKAGE*)
	  (princ (SYMBOL-NAME object)))
	 ((null (SYMBOL-PACKAGE object))
	  (princ "#:")
	  (princ (SYMBOL-NAME object)))
	 (t
	  (princ (PACKAGE-NAME (SYMBOL-PACKAGE object)))
	  (princ ":")
	  (princ (SYMBOL-NAME object)))))
      ((CHARACTERP object)
       (princ "#\\")
       (princ (or (CHAR-NAME object)
		  (string (CHAR-CODE object)))))
      ((cl::bignump object)
       (when (MINUSP object)
	 (princ "-")
	 (setq object (cl:- object)))
       (princ "#x")
       (let ((start t))
	 (dotimes (i (1- (length object)))
	   (let ((num (aref object (- (length object) i 1))))
	     (dotimes (j 7)
	       (let ((n (logand (ash num (* -4 (- 6 j))) 15)))
		 (unless (and (zerop n) start)
		   (setq start nil)
		   (princ (string (aref "0123456789ABCDEF" n))))))))))
      ((cl::ratiop object)
       (PRINT (NUMERATOR object))
       (princ "/")
       (PRINT (DENOMINATOR object)))
      ((COMPLEXP object)
       (princ "#C(")
       (PRINT (REALPART object))
       (princ " ")
       (PRINT (IMAGPART object))
       (princ ")"))
      ((consp object)
       (princ "(")
       (PRINT (car object))
       (dolist (obj (cdr object))
	 (princ " ")
	 (PRINT obj))
       (princ ")"))
      ((BIT-VECTOR-P object)
       (princ "#*")
       (dotimes (i (LENGTH object))
	 (princ (AREF object i))))
      ((STRINGP object)
       (print (copy-seq object)))
      ((VECTORP object)
       (princ "#(")
       (dotimes (i (LENGTH object))
	 (PRINT (AREF object i))
	 (when (< (1+ i) (LENGTH object))
	   (princ " ")))
       (princ ")"))
      ((PACKAGEP object)
       (PRINT-UNREADABLE-OBJECT (object stream)
         (princ (PACKAGE-NAME object))))
      ((READTABLEP object)
       (PRINT-UNREADABLE-OBJECT (object stream :identity t)))
      ((STREAMP object)
       (PRINT-UNREADABLE-OBJECT (object stream :identity t)
         (cond
	   ((STREAM-filename object)
	    (princ object))
	   ((bufferp (STREAM-content object))
	    (princ (buffer-name (STREAM-content object))))
	   ((STRINGP (STREAM-content object))
	    (princ (string 34))
	    (princ (STREAM-content object))
	    (princ (string 34))))))
      (t
       (error))))
  object)
